---
title: "QQM Mobility"
  knit: (function(input_file, encoding) {
    out_dir <- 'docs';
    rmarkdown::render(input_file,
      encoding=encoding,
      output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Rowan Carew"
date: "2023-11-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
load("database_PT_final.Rda")
#NB - the data is called "database"

database_choices=read.csv("finaldata.csv",header=TRUE)

database<-inner_join(database_choices, database, by ='RID')
```

#Setting Up

```{r}
#Load libraries
library(dplyr)
library(ggplot2)
library(naniar)
library(tidyverse)
library(janitor)
library(skimr)
library(psych)
library(ggdist)
library(car)
library(correlation)
library(scales)
```

```{r}
database <-
  database %>%
  mutate(sex_front = as.factor(sex_front),
         p_bundesland_front = as.factor(p_bundesland_front),
         p_educ_front = as.factor(p_educ_front),
         age_front = as.integer(age_front),
         m_known = as.factor(m_known),
         DRT_knowledge = as.factor(DRT_knowledge),
         p_place_inhab = as.factor(p_place_inhab),
         p_mtools_1 = as.factor(p_mtools_1)
         )

glimpse(database)
```

```{r}
# Narrow down the dataset to only include rural inhabitants, which is <5,000 people.
database_rural <- subset(database, p_place_inhab %in% c(1,2))

database_nonrural <- subset(database, p_place_inhab %in% c(3,4,5))

```

```{r}
table(database_rural$sex_front)

database_rural_boomer_filtered <- database_rural %>%
  filter(DURATION < quantile(DURATION, 0.95))

ggplot(data = database_rural_boomer_filtered) + 
  geom_point(mapping = aes(x = age_front, y = DURATION)) +
  geom_smooth(mapping = aes(x = age_front, y = DURATION)) +
ggtitle ("Boomerism and being shit at surveys")
```
```{r}
database_rural_boomer_filtered %>%
  select(age_front, DURATION) %>%
  correlation(method = "spearman")
```
#Car Ownership Visualisations

## Do you own a car?

```{r}
#I want to create a clustered bar chart showing the different frequencies of whether people own a car or not in different Austrian states.

#First, I will rename the variables. This will make the graph more readable.
library(dplyr)

#Create a copy of the database to play with.
database_test <- database_rural

#Rename the variables. Start with value mapping (vm)
database_test__p_bundesland_vm <- c("1" = "Burgenland", "2" = "Kärnten", "3" = "Niederösterreich", "4" = "Oberösterreich", "5" = "Salzburg", "6" = "Steiermark", "7" = "Tirol", "8" = "Vorarlberg", "9" = "Wien", "10" = "Not Austria")

database_test_p_mtools_1_vm <- c("1" = "No", "2" = "Yes")

#Now I use the value maapping above to rename the values.
database_test <- database_test %>%
  mutate(p_bundesland_front = factor(p_bundesland_front, levels = as.character(1:10), labels = database_test__p_bundesland_vm))

database_test <- database_test %>%
  mutate(p_mtools_1 = factor(p_mtools_1, levels = as.character(1:2), labels = database_test_p_mtools_1_vm))



# Here I create a clustered bar chart.

library(ggplot2)
ggplot(database_test, aes(x = p_bundesland_front, fill = p_mtools_1)) +
  geom_bar(aes(y = after_stat(count/5)), position = "dodge") +
  labs(title = "Car ownership across Austrian states",
       x = "p_bundesland_front",
       y = "Frequency") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```
## Which mobility options do you use?
```{r}
# Create a data frame
library(dplyr)
library(tidyr)
library(ggplot2)
library(reshape2)

#Create a copy of the database to play with.
database_test_p_mtools <- database_rural %>%
  select(p_mtools_1, p_mtools_2, p_mtools_3, p_mtools_4, p_mtools_5, p_mtools_6)

#Show tables for the p_mtools variables. We will use the values from the tables to manually create a data frame with which we can create a clustered bar chart.Remember, the values need to be divided by 5, as we multiplied the data by 5 when merging the two datasets.

table(database_test_p_mtools$p_mtools_1)
table(database_test_p_mtools$p_mtools_2)
table(database_test_p_mtools$p_mtools_3)
table(database_test_p_mtools$p_mtools_4)
table(database_test_p_mtools$p_mtools_5)
table(database_test_p_mtools$p_mtools_6)

#Creating dataframes
database_test_p_mtools_df <- data.frame(
  "mobility.tool" = c("Own car", "Household Car", "Motorbike or Moped", "Bike or E-Bike", "Scooter or E-Scooter", "Carsharing Membership"),
  "no" = c(81, 291, 397, 235, 423, 445),
  "yes" = c(371, 161, 55, 217, 29, 7)
  )

#I now need to reshape the data, which will make it possible to plot in a clustered bar graph.
melted_data_p_mtools <- reshape2::melt(database_test_p_mtools_df, id.vars = "mobility.tool")

# Create a clustered bar chart
ggplot(melted_data_p_mtools, aes(x = `mobility.tool`, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Mobility options in rural areas",
       x = "mobility option",
       y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


```{r}
# Creating database that excludes NA data
database_inhab_complete <- subset(database, p_place_inhab %in% c(1,2,3,4,5))

# Vector assigning values 1 through 5 to the explanations of p_place_inhab used for labeling
inhabitants <- c("1" = "up to 1,000", "2"="1,000 to 5,000", "3" = "5,000 to 50,000", "4" = "50,000 to 100,000", "5" ="more than 100.000")

# Converts p_place_inhab in database_inhab_complete into a factor variable with levels 1 to 5 and labels assigned from the inhabitants vector
database_inhab_complete <- database_inhab_complete %>%
    mutate(p_place_inhab = factor(p_place_inhab, 
                                          levels = as.character(1:5), 
                                          labels = inhabitants))
# Designs the clustered bar chart
ggplot(database_inhab_complete, aes(x = n_o_v_hh, fill = p_place_inhab)) +
  geom_bar(position = "dodge") +
  labs(title = "How many cars in which sized town?",
       x = "Number of cars",
       y = "Frequency") 
```


