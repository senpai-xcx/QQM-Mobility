---
title: "Polychoric Correlation"
author: "Rowan Carew"
date: "2023-12-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
###MERGING DATA SET AND DEFINING VARIABLES AS ORDINAL#####
load("database_PT_final.Rda")
#NB - the data is called "database"

database_choices=read.csv("finaldata.csv",header=TRUE)

library(dplyr)
database<-inner_join(database_choices, database, by ='RID')

#This code is for changing the variables to the correct data type.
database <-
  database %>%
  mutate(sex_front = as.factor(sex_front),
         p_bundesland_front = as.factor(p_bundesland_front),
         p_educ_front = as.factor(p_educ_front),
         age_front = as.integer(age_front),
         m_known = as.factor(m_known),
         DRT_knowledge = as.factor(DRT_knowledge),
         p_place_inhab = as.factor(p_place_inhab),
         p_mob_ptintensity = as.factor(p_mob_ptintensity),
         p_mtools_1 = as.factor(p_mtools_1),
         p_central_wien = as.factor(p_central_wien),
         p_central_nonwien = as.factor(p_central_nonwien),
         kilometrage_per_car_1 = as.factor(kilometrage_per_car_1),
         kilometrage_per_car_2 = as.factor(kilometrage_per_car_2),
         kilometrage_per_car_3 = as.factor(kilometrage_per_car_3),
         kilometrage_per_car_4 = as.factor(kilometrage_per_car_4),
         n_o_v_hh = as.factor(n_o_v_hh),
         income = as.factor(income),
         children_1 = as.factor(children_1),
         children_2 = as.factor(children_2),
         children_3 = as.factor(children_3),
         status = as.factor(status),
         n_o_hhm = as.factor(n_o_hhm),
         p_season_1 = as.factor(p_season_1),
         p_season_2 = as.factor(p_season_2),
         p_season_3 = as.factor(p_season_3),
         p_season_4 = as.factor(p_season_4)
         )

# Narrow down the dataset to only include rural inhabitants, which is <5,000 people.
database_rural <- subset(database, p_place_inhab %in% c(1,2))
```


```{r}
library(polycor)


poly_corr_car_ownership <- hetcor(database_rural[, c('p_mtools_1', 'p_central_nonwien','p_mob_ptintensity')], ML = TRUE)
print(poly_corr_car_ownership)

kruskal.test(p_mtools_1 ~ p_central_nonwien, data = database_rural)
kruskal.test(p_mtools_1 ~ p_mob_ptintensity, data = database_rural)


######USE THIS TO DEBUG IN CASE THERE ARE NOT ENOUGH DISTINCT VARIABLES -> shows levels##########
#sapply(lapply(database, unique), length)
```

### Regression Test
```{r}
library(MASS)
library(lmtest)
library(AER)
library(modelsummary)
rural_income_model <- polr(n_o_v_hh ~ n_o_hhm + children_1 + children_2 + children_3, data = database_rural, Hess=TRUE)
summary(rural_income_model)

# QUESTION FOR STEFANIE: The regression model above gives us coefficients, std. errors and t values. The t values represent measures of how many standard errors the estimated coefficient is away from zero. A larger t-value indicates a stronger evidence against the null hypothesis that the true coefficient is zero.

#Now to calculate the p-values:
tidy_custom.polr <- function(x, ...) {
  s <- coeftest(x)
  out <- data.frame(
    term = row.names(s),
    p.value = s[, "Pr(>|z|)"])
  out
}
```


```{r}
mod = list(
  "LM" = lm(n_o_v_hh ~ n_o_v_hh + n_o_hhm + children_1 + children_2 + children_3, data = database_rural),
  "POLR" = polr(as.ordered(n_o_v_hh) ~ n_o_hhm + children_1 + children_2 + children_3, data = database_rural))

modelsummary(mod, stars = TRUE)

#https://modelsummary.com/articles/modelsummary.html#adding-new-information-to-existing-models-1
```

```{r}
centrality <- polr(p_central_nonwien ~ p_place_inhab + p_mob_ptintensity, data = database_rural, Hess=TRUE)
summary(centrality)
```


